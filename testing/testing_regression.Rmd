---
title: "Section Regression Work"
author: "Ava Swanson"
date: "11/3/2020"
output: html_document
---

Include  model  that  supplements overall points made in the project
(Could do satisfaction ~ various other factors)
Analysis of probability
Show actual regression and table output ideally, but at least description

```{r setup, include=FALSE}

library(tidyverse)
library(rstanarm)
library(gtsummary)
library(gt)
library(tidymodels)
library(rstanarm)
library(broom.mixed)
library(ggridges)

```


```{r}


### Model Data ###


set.seed(10)

model_data <- responses_final %>%
  mutate(gender = str_replace(gender, 
                              pattern = "Genderqueer/Gender Non-Conforming", 
                              replacement = "Other")) %>%
  mutate(gender = str_replace(gender, pattern = "Prefer not to say", 
                              replacement = "Other")) %>%
  mutate(on_campus = if_else(!location %in% c("At Home (in the US)", 
                          "At Home (international student)"), TRUE, FALSE)) %>%
  select(on_campus, gender, satisfaction, group_size, location, race) %>%
  # mutate(on_campus = as.numeric(on_campus)) %>%
    mutate(satisfaction = str_replace(
      satisfaction, pattern = "Very Satisfied", replacement = "2")) %>%
  mutate(satisfaction = str_replace(
    satisfaction, pattern = "Satisfied", replacement = "1")) %>%
  mutate(satisfaction = str_replace(
    satisfaction, pattern = "Neutral", replacement = "0")) %>%
  mutate(satisfaction = str_replace(
    satisfaction, pattern = "Dissatisfied", replacement = "-1")) %>%
  mutate(satisfaction = str_replace(
    satisfaction, pattern = "Very Dissatisfied", replacement = "-2")) %>%
  mutate(satisfaction = str_replace(
    satisfaction, pattern = "Very -1", replacement = "-2"))

model_data$satisfaction <- as.integer(as.character(model_data$satisfaction))
model_data$group_size <- as.integer(as.character(model_data$group_size))

```

```{r}


### FINAL PRODUCT ###

  # TEXT: Our flagship model regressed the variables Group Size, On Campus, and
  # the interaction between the two onto Satisfaction. For context, Group Size
  # indicates the number of virtual relationships that were translated into
  # in-person connections, and On Campus indicates whether or not the first-year
  # student is living on campus during Fall 2020. Satisfaction represents the
  # self-reported level of social satisfaction, with levels "Very Dissatisfied,"
  # "Dissatisfied," "Neutral," "Satisfied," and "Very Satisfied." These levels
  # were numerically converted to "-2," "-1," "0," "1," and "2," respectively.


# Flagship Stan Model



fit_gs <- stan_glm(data = model_data,
   formula = satisfaction ~ group_size + on_campus + on_campus:group_size + 1,
   family = gaussian(),
   refresh = 0)



############################################################################



# Output Table

  # TEXT: Included is our output table from our flagship model. The beta value
  # of our Intercept indicates the predicted value of satisfaction when "Group
  # Size" is equal to zero and the student is living off-campus with no
  # interaction between the two predictors. The beta value for group_size
  # reveals the predicted change in satisfaction for every increase in 1 
  # for "Group Size" while holding "On Campus" constant. 
  # The beta value for on_campus represents the predicted change in satisfaction 
  # when "Group Size" is held constant and the student were to switch from living
  # off-campus to on-campus. 

  # Our interaction term is group_size*on_campus,
  # which we include because we suspect the value of one predictor will depend
  # on the value of the other (for instance, we assume Group Size values are
  # dramatically smaller for students who live off campus due to lack of 
  # opportunity to form an in-person connection from one that was previously
  # virtual). To interpret this interaction term, we must do so in the context
  # of the other predictors. If we add the beta values for the Intercept,
  # group_size, on_campus, and the interaction term, we receive a value of about
  # 0.11. Essentially, this means that if we increase a student's group_size by 
  # 1 and change campus status from off to on, we can expect a predicted change 
  # of satisfaction from -0.66 to 0.11. Such a change from a largely negative 
  # to a positive social experience during the hybrid Covid semester is nothing
  # to sneeze at. 

tbl_regression(fit_gs, intercept = TRUE) %>%
  as_gt() %>%
  tab_header(title = "Satisfaction Regression",
             subtitle = 
        "The Effect of Group Size and On-Campus Living on Social Satisfaction")



############################################################################



# Graphs Part 1 -- Epreds (Using Flagship Stan Model)

  # TEXT: We have included graphical displays of our flagship model. The first
  # two represent estimated averages through posterior distributions
  # on conditional expectations. 

  # TEXT (Graph 1): In the graph above, we examine the estimated average
  # satisfaction for on-campus students with Group Sizes 0-10 and 15 and 20. We
  # gather that as Group Size increases, overall social satisfaction tends to
  # also positively increase. 

  # TEXT (Graph 2): In our second graph, we examine the predicted average
  # difference in social satisfaction between on campus students who have
  # group sizes of 5 and those with group sizes of 0. It appears there is a 
  # median predicted average difference in satisfaction of roughly 0.27 in favor
  # of those with the larger group size.

  # TEXT (Graph 3): Rather than modeling predicted average distributions after 
  # conditional expectations of student characteristics, graphs 3 through 5 
  # model outputs directly through posterior probability distributions. Graph 3,
  # using our flagship model, displays the predicted probability distribution
  # for social satisfaction between students living on and off campus. There
  # appears to be a significant difference in predicted satisfactions 
  # between those living on and off campus, with those living off-campus
  # expected to have a decidedly negative social experience compared to their
  # on-campus counterparts.

  # TEXT (Graph 4): Using a new model that specifies between residential location 
  # rather than simply whether a student is on or off campus, we regressed
  # the location variable from our dataset onto satisfaction, selecting only
  # to use locations on campus. In particular, we wanted to analyze differences
  # between those living in the Yard and those living in the Quad, given that this
  # year due to dedensified Covid living, a significant portion of first year students
  # are living in the Quad, which is characteristically upper-classmen housing. 
  # Graph 4 reveals a higher predicted distribution for satisfaction for those living
  # in the Yard than those in the Quad, although there is immense overlap and the difference
  # is not nearly as dramatic as that for on vs. off campus social satisfaction.

  # TEXT (Graph 5): Once again using a similarly new model as the one in Graph 4, except
  # this time regressing on-campus location on Group Size, we see a similar disparity
  # in the predicted distributions for Group Size between Quad and Yard first-years as
  # the distributions for satisfaction. Yard students tend to have a higher predicted
  # Group Size, although there is immense overlap.


new_data = tibble(group_size = c(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 15, 20),
                  on_campus = TRUE)

preds <- posterior_epred(fit_gs, newdata = new_data) %>%
  as_tibble() %>%
  rename("0" = `1`, "1" = `2`, "2" = `3`, "3" = `4`, "4" = `5`, "5" = `6`,
         "6" = `7`, "7" = `8`, "8" = `9`, "9" = `10`, "10" = `11`, "15" = `12`,
         "20" = `13`)


  ## GRAPH 1: Estimated Average Satisfaction Across Group Sizes 1:20 ##


long_preds <- preds %>%
    pivot_longer(cols = "0":"20", 
               names_to = "Group_Size",
               values_to = "Satisfaction")

long_preds$"Group_Size" <- factor(long_preds$"Group_Size", levels= c("0":"20"))
  
long_preds %>%
  ggplot(aes(x = `Satisfaction`, y = Group_Size, fill = stat(x))) +
  geom_density_ridges_gradient(bandwidth = 0.2) +
  scale_fill_viridis_c(name = "Group Size") +
  theme_classic() +
  labs(title = "Estimated Average Social Satisfaction", subtitle = 
         "Group Sizes 0-20 for On-Campus Students", y = "Group Size")


  ## GRAPH 2: Estimated Average Difference in Satisfaction w/ On-Campus Students Group Sizes 0 and 5 ##
   

preds %>%
  as_tibble() %>%
  mutate(diff = `5` - `0`) %>%
  ggplot(aes(x = diff)) +
  geom_histogram(aes(y = after_stat(count / sum(count))), bins = 100, 
                 fill = "steelblue", alpha = 0.6) +
  theme_bw() +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(y = "Percentage", x = "Difference", title = 
         "Estimated Average Difference in Social Satisfaction", subtitle = 
         "Between On-Campus Students with Group Sizes 5 and 0")



############################################################################



# Graphs Part 2 -- Variable Posterior Probability Distribution Comparisons



  # GRAPH 3: Posterior Probability Distribution of Satisfaction for On vs. Off Campus


fit_gs %>%
  as_tibble() %>%
  mutate(on = `(Intercept)` + on_campusTRUE) %>%
  rename(off = `(Intercept)`) %>%
  select(on, off) %>%
  pivot_longer(cols = off:on, 
               names_to = "parameters",
               values_to = "satisfaction") %>%
   ggplot(aes(satisfaction, fill = parameters)) +
    geom_histogram(aes(y = after_stat(count/sum(count))),
                   alpha = 0.5, 
                   bins = 100, 
                   position = "identity") +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_bw() +
  labs(x = "Social Satisfaction", y = "Probabiliy", title = 
         "Posterior Probability Distribution", subtitle = 
         "Average Satisfaction for On vs. Off Campus Students", fill = "Off vs. On Campus")


  # GRAPH 4: Posterior Probability Distribution of Satisfaction, Yard vs. Quad (New Model Generated)

model_data3 <- model_data %>%
  filter(location %in% c("The Yard", "The Quad", "A River House")) %>%
  mutate(location = str_replace(location, 
                              pattern = "The Yard", 
                              replacement = "yard")) %>%
  mutate(location = str_replace(location, 
                              pattern = "The Quad", 
                              replacement = "quad")) %>%
  mutate(location = str_replace(location, 
                              pattern = "A River House", 
                              replacement = "river"))
  # filter(location == c("yard", "quad"))

yvq_model_1 <- stan_glm(data = model_data3,
                 formula = satisfaction ~ location,
                 refresh = 0)

yvq_model_clean1 <- yvq_model_1 %>%
  as_tibble() %>%
  mutate(yard = `(Intercept)` + locationyard + locationriver) %>%
  rename(quad = `(Intercept)`) %>%
  select(yard, quad) %>%
  pivot_longer(cols = yard:quad, 
               names_to = "parameters",
               values_to = "satisfaction")

yvq_model_clean1 %>%
  ggplot(aes(satisfaction, fill = parameters)) +
    geom_histogram(aes(y = after_stat(count/sum(count))),
                   alpha = 0.5, 
                   bins = 100, 
                   position = "identity") +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_bw() +
  labs(x = "Social Satisfaction", y = "Probability", title = 
         "Posterior Probability Distribution", subtitle = 
         "Average Satisfaction for Quad vs. Yard Students",
       caption = "Model Formula: satisfaction ~ location", fill = "Quad vs. Yard")


  # GRAPH 5: Posterior Probability Distribution of Group Size, Yard vs. Quad (New Model Generated)


yvq_model_2 <- stan_glm(data = model_data3,
                 formula = group_size ~ location,
                 refresh = 0)

yvq_model_clean2 <- yvq_model_2 %>%
  as_tibble() %>%
  mutate(yard = `(Intercept)` + locationyard + locationriver) %>%
  rename(quad = `(Intercept)`) %>%
  select(yard, quad) %>%
  pivot_longer(cols = yard:quad, 
               names_to = "parameters",
               values_to = "group_size")

yvq_model_clean2 %>%
  ggplot(aes(group_size, fill = parameters)) +
    geom_histogram(aes(y = after_stat(count/sum(count))),
                   alpha = 0.5, 
                   bins = 100, 
                   position = "identity") +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_bw() +
  labs(x = "Group Size", y = "Probability", title = 
         "Posterior Probability Distribution", subtitle = 
         "Average Group Size for Quad vs. Yard Students",
       caption = "Model Formula: group_size ~ location", fill = "Quad vs. Yard")


```


```{r}

# Model: Workflow 

model_data_split <- initial_split(model_data)
model_data_train <- training(model_data_split)
model_data_test <- testing(model_data_split)
model_data_folds <- vfold_cv(model_data_train, v = 5)

model_wfl <- workflow() %>% 
  add_model(linear_reg() %>% 
              set_engine("stan")) %>% 
  add_recipe(recipe(satisfaction ~ group_size + on_campus,
                    data = model_data_train) %>%
               step_interact(~ group_size:on_campus))

results <- model_wfl %>% 
  fit(data = model_data_train) %>% 
  predict(new_data = model_data_test) %>% 
  bind_cols(model_data_test %>% select(satisfaction)) %>% 
  metrics(truth = satisfaction, estimate = `.pred`)

model_cross <- model_wfl %>% 
  fit_resamples(resamples = model_data_folds) %>% 
  collect_metrics()
```


# TESTING CODE BELOW

```{r}

# TEST with epred yard v quad stuff #

yvq_model_1 <- stan_glm(data = model_data3,
                 formula = satisfaction ~ location + group_size + group_size:location,
                 refresh = 0)

# new_data3 = tibble(location = c("yard", "quad", "yard", "quad", "yard", "quad", "yard", "quad", "yard", "quad"),
#                   satisfaction = c(-2, -2, -1, -1, 0, 0, 1, 1, 2, 2))

new_data2 = tibble(location = c("yard", "quad", "yard", "quad", "yard", "quad"),
                   group_size = c(0, 0, 5, 5, 10, 10))

posterior_epred(yvq_model_1, newdata = new_data2) %>%
  as_tibble() %>%
  # rename("-2" = `1`, "-1" = `2`, "0" = `3`, "1" = `4`, "2" = `5`) %>%
  # rename("yard" = `1`, "quad" = `2`) %>%
  pivot_longer(cols = `1`:`6`, 
               names_to = "location",
               values_to = "satisfaction") %>%
  ggplot(aes(satisfaction, fill = location)) +
    geom_histogram(aes(y = after_stat(count/sum(count))),
                   alpha = 0.5, 
                   bins = 100, 
                   position = "identity") +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_bw()
  # facet_wrap(~ location)
  
  
  ggplot(aes(x = `satisfaction`, y = location, fill = stat(x))) +
  geom_density_ridges_gradient(bandwidth = 0.2) +
  scale_fill_viridis_c(name = "location") +
  theme_classic()

  
# RACE #

# Posterior Probability Distribution of Satisfaction, by Race


  race_data <- model_data %>%
  mutate(race = str_replace(race, pattern = "Hispanic or Latino", replacement = "Latino")) %>%
  mutate(race = str_replace(race, pattern = "Black or African American", replacement = "Black")) %>%
    select(race, satisfaction, group_size)


race_model1 <- stan_glm(data = race_data,
                 formula = satisfaction ~ race,
                 refresh = 0)

race_clean_1 <- race_model1 %>%
  as_tibble() %>%
  mutate(Black = `(Intercept)` + raceBlack) %>%
  mutate(Latino = `(Intercept)` + raceBlack + raceLatino) %>%
  mutate(Other = `(Intercept)` + raceBlack + raceLatino + raceOther) %>%
  mutate(White = `(Intercept)` + raceBlack + raceLatino + raceOther + raceWhite) %>%
  rename(Asian = `(Intercept)`)

race_clean_1 <- race_clean_1 %>%
  select(Asian, White, Black, Latino, Other)

race_clean_1 <- race_clean_1 %>%
  pivot_longer(cols = Asian:Other, 
               names_to = "parameters",
               values_to = "satisfaction")

race_clean_1 %>%
  ggplot(aes(satisfaction, fill = parameters)) +
    geom_histogram(aes(y = after_stat(count/sum(count))),
                   alpha = 0.9, 
                   bins = 100, 
                   position = "identity") +
  theme_classic() +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(x = "Satisfaction", y = "Probability", title = 
         "Posterior Probability Distribution", subtitle = 
         "Average Social Satisfaction by Racial/Ethnicity",
       caption = "Model Formula: satisfaction ~ race")


  # Posterior Probability Distribution of Group_Size, by Race


race_model2 <- stan_glm(data = race_data,
                 formula = group_size ~ race - 1,
                 refresh = 0)

race_clean_2 <- race_model2 %>%
  as_tibble() %>%
  select(-sigma) %>%
  rename("Asian" = raceAsian, "White" = raceWhite, "Black" = raceBlack, "Other" = raceOther, "Latino" = raceLatino) %>%
  pivot_longer(cols = Asian:White, 
               names_to = "parameters",
               values_to = "group_size")

race_clean_2 %>%
  ggplot(aes(group_size, fill = parameters)) +
    geom_histogram(aes(y = after_stat(count/sum(count))),
                   alpha = 0.7, 
                   bins = 100, 
                   position = "identity") +
  theme_classic() +
  scale_y_continuous(labels = scales::percent_format()) +
   labs(x = "Group Size", y = "Probability", title = 
         "Posterior Probability Distribution", subtitle = 
         "Average Group Size by Racial/Ethnicity",
        caption = "Model Formula: group_size ~ race")



```


```{r}
# Grouped all on campus individuals to be on campus or not. Replaced
# satisfaction levels with an integer value. Grouped extraneous gender
# variants as "Other." Converted Satisfaction and Group_Size values to 
# integers.

fit_gs <- stan_glm(data = model_data,
   formula = satisfaction ~ group_size + on_campus + on_campus:group_size + 1,
   family = gaussian(),
   refresh = 0)

print(fit_gs, digits = 5)

# model_interval <- posterior_interval(fit_gs, prob = 0.95)

fit_graph <- fit_gs %>%
  as_tibble() %>%
  ggplot(aes(x = group_size, y = after_stat(count / sum(count)))) +
  geom_histogram(binwidth = 0.01, bins = 100,
                 color = "white", fill = "#6fb4d2") +
  theme_bw() +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(x = "Group Size", y = "Probability")


tbl_regression(fit_gs, intercept = TRUE) %>%
  as_gt() %>%
  tab_header(title = "Satisfaction Regression",
             subtitle = 
        "The Effect of Group Size and On-Campus Living on Social Satisfaction")

# Interpretation: Our median value for group_size, -0.03, is the estimated 
# change in average group_size for students when the on_campus variable is held at zero, 
# or "off-campus." The median value for on_campus, 0.06, is the estimated change
# in "being on_campus" when group_size is held at zero. The median value for 
# group_size:on_campus represents the estimated effect on satisfaction when 
# both group_size and on_campus are held constant. Thus, when group_size is held
# constant and the value of on_campus is equal to one (the student is living on
# campus), then we can expect an increase in satisfaction of about 0.10 on average.

# 


############################################################################
# Model testing

fit2 <- stan_glm(data = model_data,
         formula = satisfaction ~ on_campus - 1,
         family = gaussian(),
         refresh = 0)

print(fit2, digits = 4)

interval <- posterior_interval(fit2, prob = 0.95)


fit2 %>%
  as_tibble() %>%
  ggplot(aes(x = on_campus, y = after_stat(count / sum(count)))) +
  geom_histogram(binwidth = 0.01, bins = 100,
                 color = "white", fill = "#6fb4d2") +
  # geom_vline(aes(xintercept = interval[1]), color = "blue1") +
  # geom_vline(aes(xintercept = interval[3]), color = "blue1") +
  theme_bw() +
  scale_y_continuous(labels = scales::percent_format())

```
# increase group size by one but stay off campus, go from -0.66 to about -0.5something,
# increase group size by one and move from off campus to on campus, then we have to account for 
all four; we take our intercept and we add ourgroup size and on campus and we add (subtract)
interaction term for groupsize: on campus. Negative to a positive satisfaction level.
results in 0.11. 



```{r}

# Model: Workflow Edition (Part 2)

model_data_split <- initial_split(model_data)
model_data_train <- training(model_data_split)
model_data_test <- testing(model_data_split)
model_data_folds <- vfold_cv(model_data_train, v = 5)

model_wfl <- workflow() %>% 
  add_model(linear_reg() %>% 
              set_engine("stan")) %>% 
  add_recipe(recipe(satisfaction ~ group_size + on_campus,
                    data = model_data_train) %>%
               step_interact(~ group_size:on_campus))

results <- model_wfl %>% 
  fit(data = model_data_train) %>% 
  predict(new_data = model_data_test) %>% 
  bind_cols(model_data_test %>% select(satisfaction)) %>% 
  metrics(truth = satisfaction, estimate = `.pred`)

model_cross <- model_wfl %>% 
  fit_resamples(resamples = model_data_folds) %>% 
  collect_metrics()

```

```{r}

# Average satisfaction as a function of group_size, divided by on_campus

fit_gs %>% 
  as_tibble() %>% 
  mutate(male_days = `(Intercept)` + sexMale) %>% 
  rename(female_days = `(Intercept)`) %>% 
  select(female_days, male_days) %>% 
  pivot_longer(cols = female_days:male_days, 
               names_to = "parameters",
               values_to = "days") %>% 
  ggplot(aes(days, fill = parameters)) +
    geom_histogram(aes(y = after_stat(count/sum(count))),
                   alpha = 0.5, 
                   bins = 100, 
                   position = "identity") +
    labs(title = "Posterior Probability Distribution",
         subtitle = "Men live longer",
         x = "Average Days Lived Post Election",
         y = "Probability") + 
    scale_x_continuous(labels = scales::number_format()) +
    scale_y_continuous(labels = scales::percent_format()) +
    theme_classic()

```

```{r}

# SHOTGUN MODELING

one <- stan_glm(formula = satisfaction ~ group_size + 1,
                data = model_data,
                refresh = 0,
                family = gaussian())
one %>%
  as_tibble() %>%
  ggplot(aes(x = group_size, y = after_stat(count / sum(count)))) +
  geom_histogram(binwidth = 0.01, bins = 100,
                 color = "white", fill = "#6fb4d2") +
  theme_bw() +
  scale_y_continuous(labels = scales::percent_format())

sat_on <- stan_glm(formula = satisfaction ~ on_campus - 1,
                data = model_data,
                refresh = 0,
                family = gaussian())

sat_on %>%
  as_tibble() %>%
  ggplot(aes(x = on_campusFALSE, y = after_stat(count / sum(count)))) +
  geom_histogram(binwidth = 0.01, bins = 100,
                 color = "white", fill = "#6fb4d2") +
  theme_bw() +
  scale_y_continuous(labels = scales::percent_format())




three <- stan_glm(formula = satisfaction ~ group_size*on_campus + 1,
                data = model_data,
                refresh = 0,
                family = gaussian())

three %>%
  as_tibble() %>%
  ggplot(aes(x = on_campus, y = after_stat(count / sum(count)))) +
  geom_histogram(binwidth = 0.01, bins = 100,
                 color = "white", fill = "#6fb4d2") +
  theme_bw() +
  scale_y_continuous(labels = scales::percent_format())
  
  
  
  
  # find way to pull distributions from the joint model, not individually.
  
  
  
  
  #  pivot_longer(cols = genderFemale:genderOther, 
  #              names_to = "parameters",
  #              values_to = "group_size") %>%
  # ggplot(aes(x = group_size, fill = "paramters")) +
  # geom_histogram(aes(y = after_stat(count/sum(count))),
  #                  alpha = 0.5, 
  #                  bins = 100, 
  #                  position = "identity") +
  # theme_bw() +
  # scale_y_continuous(labels = scales::percent_format())























```

```{r}

# IDIVIDUAL POSTERIORS


# Gender 

  # Group_Size

model_data2 <- model_data %>%
  filter(gender != "Other")

expo1 <- stan_glm(data = model_data2,
                 formula = group_size ~ gender,
                 refresh = 0)

graphy <- expo1 %>%
  as_tibble() %>%
  mutate(male = `(Intercept)` + genderMale) %>%
  rename(female = `(Intercept)`) %>%
  select(male, female) %>%
  pivot_longer(cols = male:female, 
               names_to = "parameters",
               values_to = "group_size")

graphy %>%
  ggplot(aes(group_size, fill = parameters)) +
    geom_histogram(aes(y = after_stat(count/sum(count))),
                   alpha = 0.5, 
                   bins = 100, 
                   position = "identity") +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_bw()


  # Satisfaction


model_data2 <- model_data %>%
  filter(gender != "Other")

expos <- stan_glm(data = model_data2,
                 formula = satisfaction ~ gender,
                 refresh = 0)

graphl <- expos %>%
  as_tibble() %>%
  mutate(male = `(Intercept)` + genderMale) %>%
  rename(female = `(Intercept)`) %>%
  select(male, female) %>%
  pivot_longer(cols = male:female, 
               names_to = "parameters",
               values_to = "satisfaction")

graphl %>%
  ggplot(aes(satisfaction, fill = parameters)) +
    geom_histogram(aes(y = after_stat(count/sum(count))),
                   alpha = 0.5, 
                   bins = 100, 
                   position = "identity") +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_bw()


# Yard vs. Quad
    
  # Satisfaction Combat

model_data3 <- model_data %>%
  filter(location %in% c("The Yard", "The Quad", "A River House")) %>%
  mutate(location = str_replace(location, 
                              pattern = "The Yard", 
                              replacement = "yard")) %>%
  mutate(location = str_replace(location, 
                              pattern = "The Quad", 
                              replacement = "quad")) %>%
  mutate(location = str_replace(location, 
                              pattern = "A River House", 
                              replacement = "river"))

expo2 <- stan_glm(data = model_data3,
                 formula = satisfaction ~ location,
                 refresh = 0)

graphy2 <- expo2 %>%
  as_tibble() %>%
  mutate(yard = `(Intercept)` + locationyard) %>%
  rename(quad = `(Intercept)`) %>%
  select(yard, quad) %>%
  pivot_longer(cols = yard:quad, 
               names_to = "parameters",
               values_to = "satisfaction")

graphy2 %>%
  ggplot(aes(satisfaction, fill = parameters)) +
    geom_histogram(aes(y = after_stat(count/sum(count))),
                   alpha = 0.5, 
                   bins = 100, 
                   position = "identity") +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_bw()


  # Group Size Combat


expo3 <- stan_glm(data = model_data3,
                 formula = group_size ~ location,
                 refresh = 0)

expo3 %>%
  as_tibble() %>%
  mutate(yard = `(Intercept)` + locationyard) %>%
  rename(quad = `(Intercept)`) %>%
  select(yard, quad) %>%
  pivot_longer(cols = yard:quad, 
               names_to = "parameters",
               values_to = "group_size") %>%
  ggplot(aes(group_size, fill = parameters)) +
    geom_histogram(aes(y = after_stat(count/sum(count))),
                   alpha = 0.5, 
                   bins = 100, 
                   position = "identity") +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_bw()


# Yard, Quad, AND, River... for fun.

fun <- stan_glm(data = model_data3,
                formula = satisfaction ~ location,
                refresh = 0)

fun %>%
  as_tibble() %>%
  mutate(river = `(Intercept)` + locationriver) %>%
  mutate(yard = `(Intercept)` + locationriver + locationyard) %>%
  rename(quad = `(Intercept)`) %>%
  select(yard, quad, river) %>%
  pivot_longer(cols = yard:river, 
               names_to = "parameters",
               values_to = "satisfaction") %>%
  ggplot(aes(satisfaction, fill = parameters)) +
    geom_histogram(aes(y = after_stat(count/sum(count))),
                   alpha = 0.5, 
                   bins = 100, 
                   position = "identity") +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_bw()


# On Campus v. Off

  # Satisfaction

model_data4 <- model_data %>%
  mutate(on_campus = if_else(on_campus == "1", "ON", "OFF"))


on <- stan_glm(data = model_data4,
               family = gaussian(),
               refresh = 0,
               formula = satisfaction ~ on_campus)

on %>%
  as_tibble() %>%
  mutate(on = `(Intercept)` + on_campusON) %>%
  rename(off = `(Intercept)`) %>%
  select(on, off) %>%
  pivot_longer(cols = off:on, 
               names_to = "parameters",
               values_to = "satisfaction") %>%
  ggplot(aes(satisfaction, fill = parameters)) +
    geom_histogram(aes(y = after_stat(count/sum(count))),
                   alpha = 0.5, 
                   bins = 100, 
                   position = "identity") +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_bw()

  # Group Size

model_data4 <- model_data %>%
  mutate(on_campus = if_else(on_campus == "1", "ON", "OFF"))


on2 <- stan_glm(data = model_data4,
               family = gaussian(),
               refresh = 0,
               formula = group_size ~ on_campus)

on2 %>%
  as_tibble() %>%
  mutate(on = `(Intercept)` + on_campusON) %>%
  rename(off = `(Intercept)`) %>%
  select(on, off) %>%
  pivot_longer(cols = off:on, 
               names_to = "parameters",
               values_to = "group_size") %>%
  ggplot(aes(group_size, fill = parameters)) +
    geom_histogram(aes(y = after_stat(count/sum(count))),
                   alpha = 0.5, 
                   bins = 100, 
                   position = "identity") +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_bw()


```

```{r}


### FINAL PRODUCT ###


library(broom.mixed)
library(ggridges)

  # Flagship Stan Model

fit_gs <- stan_glm(data = model_data,
   formula = satisfaction ~ group_size + on_campus + on_campus:group_size + 1,
   family = gaussian(),
   refresh = 0)



######################################



  # Output Table

tbl_regression(fit_gs, intercept = FALSE) %>%
  as_gt() %>%
  tab_header(title = "Satisfaction Regression",
             subtitle = 
        "The Effect of Group Size and On-Campus Living on Social Satisfaction") 



######################################



# Graphs Part 1 -- Flagship Stan Model w Epreds

new_data = tibble(group_size = c(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 15, 20),
                  on_campus = TRUE)

preds <- posterior_epred(fit_gs, newdata = new_data) %>%
  as_tibble() %>%
  rename("0" = `1`, "1" = `2`, "2" = `3`, "3" = `4`, "4" = `5`, "5" = `6`,
         "6" = `7`, "7" = `8`, "8" = `9`, "9" = `10`, "10" = `11`, "15" = `12`,
         "20" = `13`)

    ## Estimated Average Satisfaction Across Group Sizes 1:20 w/ epred ##

long_preds <- preds %>%
    pivot_longer(cols = "0":"20", 
               names_to = "Group_Size",
               values_to = "Satisfaction")

long$"Group_Size" <- factor(long$"Group_Size", levels= c("0":"20"))
  
long %>%
  ggplot(aes(x = `Satisfaction`, y = Group_Size, fill = stat(x))) +
  geom_density_ridges_gradient(bandwidth = 0.2) +
  scale_fill_viridis_c(name = "Group Size") +
  theme_classic() +
  labs(title = "Estimated Average Satisfaction", subtitle = 
         "Group Sizes 0-20 for On-Campus Students", y = "Group Size")

  
  ## Estimated Average Difference in Satisfaction Between On-Campus Students Group Sizes 0 and 5 w/ epred ##
  
preds %>%
  as_tibble() %>%
  mutate(diff = `5` - `0`) %>%
  ggplot(aes(x = diff)) +
  geom_histogram(aes(y = after_stat(count / sum(count))), bins = 100, 
                 fill = "steelblue", alpha = 0.6) +
  theme_bw() +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(y = "Percentage", x = "Difference", title = 
         "Estimated Average Difference in Satisfaction", subtitle = 
         "Between On-Campus Students with Group Sizes 5 and 0")





```


























```{r}

# EXTRANEOUS

responses_clean$gap_yeardummy <- 0 

responses_clean$gap_yeardummy[which(responses_clean$gap_year == "Yes")] <- 1


fit <- stan_glm(gap_yeardummy ~ p1_closeness + gender + race,
                data = responses_clean,
                refresh = 0,
                family = binomial())


ggplot(responses_clean, aes(x = group_size)) +
geom_density()

stan_glm(group_size ~ gender + gap_year + living + location,
         data = responses_clean,
         refresh = 0,
         family = poisson())

```

